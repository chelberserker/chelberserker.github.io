<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta name="google-site-verification" content="-K9QNZ6yDB2AwLH5JwiQlIXrOiZRLjU0DFZU-F8SdF0"> <meta http-equiv="Permissions-Policy" content="interest-cohort=()"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> SURF python package | Egor Bersenev | Scattering in soft matter physics </title> <meta name="author" content="Egor A. Bersenev"> <meta name="description" content="python package for surface scattering data processing"> <meta name="keywords" content="bersenev, soft matter, X ray scattering, researcher, chemistry, reflecivity"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://chelberserker.github.io/projects/1_project_SURF/"> <script src="/assets/js/theme.js?a81d82887dd692e91686b43de4542f18"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="//"> Egor Bersenev | Scattering in soft matter physics </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications </a> </li> <li class="nav-item active"> <a class="nav-link" href="/projects/">projects <span class="sr-only">(current)</span> </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv </a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">submenus </a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item " href="/books/">bookshelf</a> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/blog/">blog</a> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/repositories/">repositories</a> </div> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">SURF python package</h1> <p class="post-description">python package for surface scattering data processing</p> </header> <article> <p>ESRF-ID10-SURF is a powerful package for analysis of surface scattering data obtain on the ID10 beamline at ESRF. It is constructed as a set of classes:</p> <ul> <li>XRR - for X-ray reflectometry analysis</li> <li>GID - for Grazing Incidence Diffraction with 1D detector and Soller collimator</li> <li>GIXS - for Grazing Incidence X-ray Scattering: both GISAXS and GIWAXS measured with a large 2D detector</li> </ul> <p>Below I will provide an explanation of various corrections, provided by the package. First, let’s deal with XRR data.</p> <h1 id="x-ray-reflectometry">X-ray Reflectometry</h1> <h2 id="experimental-setup">Experimental setup</h2> <p>The usual XRR setup on ID10 is constructed in a simple way: beam is conditioned by a double mirror to reject higher harmonics, monochromated, collimated, focused with lenses (for experiments on liquid surfaces beam incident angle is changed by a Double Crystal Deflector (DCD)) and attenuated by a set of filters. These filters are foils of the same thickness, stacked and affixed on a rotating wheel with 20 positions. Normally, each foil transmits around a third of intensity, so two filters give an order of magnitude difference. Before filters, beam intensity is measured either by an ionization chamber in DCD setup or by an avalanche photodiode measuring air scattering for experiments on solid surfaces to account for intensity fluctuations. Next, beam finally hits the sample, be it a Si wafer of a liquid surface, or any other interface. Photons can be reflected specularly, scattered or absorbed. Reflected and scattered photons are falling onto the detector, which is usually located behind slits and a flight tube at ca. 850 mm measured from the sample position.</p> <p>Filters are a crucial component for an XRR measurement, as reflectivity decays as $ q_z^{-4} $, but the detector dynamic range is limited. For example, at $q_z = 0.4 \,\text{A}^{-1}$, reflectivity $ R \simeq 10^{-8} $. That means that incoming intensity of $10^9$ will produce only 10 reflected photos, giving a very low signal-to-noise ratio. However, the same intensity around the critical angle, where reflectivity is close to 1, reflected intensity will be far out of the acceptable countrate for hybrid photon-counting detectors, typically used for this kind of experiment.</p> <p>This example illustrates the need for changing filters frequently. These foils are often crystalline, for example Cu foils. This produce an unwanted scattering, if a grain of a foil enters a Bragg condition. A share of photons is thus scattered, leading to a slightly different transmission coefficient. This is amplified by a non-uniformity in thickness of the filters, misalignment and leads to jumps in detected intensity, when filters changes. To mitigate this problem, two counts are performed at the same incident angle: one with the old filter, and one with a new one. This allows to calculate a “true” transmission ratio and get rid of the jumps in reflectivity.</p> <p>Use of 2D detectors gives two very important advantages:</p> <ul> <li>Increased resolution</li> <li>Simultaneous detection of diffuse scattering and background</li> </ul> <p>Below is an example of several detector images, demonstrating these advantages. First, on the left figure a detector image shows a detector image on top with clearly visible gap between modules, shadows from the slits in front of the flight tube. Also, a specular reflection (sharp) and a diffuse Bragg peak (broad) are marked with arrows. Intensity integration in the specular plane produces a line profile, shown in the bottom left image, which we denote $ I(X) $. Background is taken from the same area, but slightly out of reflection plane.</p> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/Annotated_detector_profile-480.webp 480w,/assets/img/Annotated_detector_profile-800.webp 800w,/assets/img/Annotated_detector_profile-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/Annotated_detector_profile.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Integrated detector image" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/detector_frames-480.webp 480w,/assets/img/detector_frames-800.webp 800w,/assets/img/detector_frames-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/detector_frames.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Different incident angles" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> On the left: Integrated detector image showing intense diffuse scattering and position of the specular reflection and the Bragg peak. <br> On the right: Detector images at various incident angles, showing evolution of the diffuse scattering. </div> <p>Resulting one-dimensional $ I(X) $ profiles are later converted to the slice of reciprocal space $ I\left(q_z, q_x, q_y=0\right) $ using the following formulae:</p> \[q_z = k*0 \left( \sin\left( \chi + \frac{ \left( PX_0 - PX \right) \cdot D_{ pix } }{ {D\_{ SDD } } } \right) + \sin\chi \right)\] \[q_x = k*0 \left( \cos\left( \chi + \frac{ \left( PX_0 - PX \right) \cdot D_{ pix } }{ { D\_{ SDD } } } \right) - \cos\chi \right)\] \[k_0 = \frac{2\pi}{\lambda}\] <p>This allows us to produce reciprocal space maps to explore diffuse scattering and potentially gain a lot of useful information at no extra measurement cost!</p> <p>Finally, at low incident angles often beam footprint exceeds sample size. This is not an issue for experiments on Langmuir through, as its width is much bigger than beam footprint at critical angle of water. In any case, a correction is required to account for this.</p> <h2 id="data-processing-logic">Data processing logic</h2> <p>Now, it is quite straightforward to think of a data processing algorithm. First, we need to integrate the 2D detector images and obtain specular reflection and background intensitites Next, we need to subtract background and normalize each point to the respective filter transmission. After that — recalculate incident angle into $ q_z $ value for each point in the scan. Next, a correct value of the incident beam intensity can be obtained from a z-scan, performed with the same filter as the initial part of reflectivity. Finally, a footprint correction can be performed, taking into account sample and beam size, with points having reflectivity&gt;1 trimmed.</p> <h3 id="initialize-the-processing-pipeline">Initialize the processing pipeline</h3> <p>First, we need to import the processing library itself and initialize our class with relevant parameters</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">ESRF_ID10_SURF.XRR</span> <span class="kn">import</span> <span class="n">XRR</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="n">FileDir</span> <span class="o">=</span> <span class="sh">'</span><span class="s">/mnt/data/ls3582/id10-surf/20251120/RAW_DATA/DPPC_0PS/DPPC_0PS_0002/</span><span class="sh">'</span>
<span class="n">FileName</span> <span class="o">=</span> <span class="sh">'</span><span class="s">DPPC_0PS_0002.h5</span><span class="sh">'</span>

<span class="nb">file</span> <span class="o">=</span> <span class="n">FileDir</span><span class="o">+</span><span class="n">FileName</span>

<span class="n">SavingDir</span> <span class="o">=</span> <span class="n">FileDir</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sh">'</span><span class="s">RAW_DATA</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">PROCESSED_DATA</span><span class="sh">'</span><span class="p">)</span>  
<span class="c1">### optional. If this argument is not given to the class, data will be saved in the folder where the script runs
</span>
<span class="n">zgH_ScanN_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">21</span><span class="p">]</span>     <span class="c1">### z-scan for normalization of intensity with the same filter
</span><span class="n">refl_ScanN_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">22</span><span class="p">,</span><span class="mi">23</span><span class="p">]</span> <span class="c1">### actual XRR scans
</span></code></pre></div></div> <p>Next, we need to create instances of our class, each will carry its own type of measurement. We will need two: one for z-scan to extract true intensity and one for the actual XRR measurement.</p> <h3 id="roi-definition-and-integration">ROI definition and integration</h3> <p>To know which part of the detector is the center (where the direct beam hits) we need to pass coordinates to the class instance. Also, we can manually define size of the region of interest for our signal, e.g. when the sample is slightly bent and reflected beam is spread across several pixels. Same goes for the gap between signal and background ROIs, which can be specified using bckg_gap parameter.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="n">PX0</span><span class="p">,</span> <span class="n">PY0</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">401</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
<span class="p">(</span><span class="n">dPX</span><span class="p">,</span> <span class="n">dPY</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">bckg_gap</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">monitor_name</span> <span class="o">=</span> <span class="sh">'</span><span class="s">ionch2</span><span class="sh">'</span>
</code></pre></div></div> <p>Now we can initialize the measurement instances:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">refl</span> <span class="o">=</span> <span class="nc">XRR</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">refl_ScanN_list</span><span class="p">,</span> <span class="n">alpha_i_name</span><span class="o">=</span><span class="sh">'</span><span class="s">mu</span><span class="sh">'</span><span class="p">,</span> <span class="n">PX0</span><span class="o">=</span><span class="n">PX0</span><span class="p">,</span> <span class="n">PY0</span><span class="o">=</span><span class="n">PY0</span><span class="p">,</span> <span class="n">dPX</span><span class="o">=</span><span class="n">dPX</span><span class="p">,</span> <span class="n">dPY</span> <span class="o">=</span><span class="n">dPY</span><span class="p">,</span> <span class="n">bckg_gap</span><span class="o">=</span><span class="n">bckg_gap</span><span class="p">,</span> <span class="n">monitor_name</span><span class="o">=</span><span class="n">monitor_name</span> <span class="p">,</span><span class="n">saving_dir</span><span class="o">=</span><span class="n">SavingDir</span><span class="p">)</span>
<span class="n">zgH</span> <span class="o">=</span> <span class="nc">XRR</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">zgH_ScanN_list</span><span class="p">,</span> <span class="n">alpha_i_name</span><span class="o">=</span><span class="sh">'</span><span class="s">zgH</span><span class="sh">'</span><span class="p">,</span> <span class="n">PX0</span><span class="o">=</span><span class="n">PX0</span><span class="p">,</span> <span class="n">PY0</span><span class="o">=</span><span class="n">PY0</span><span class="p">,</span> <span class="n">dPX</span><span class="o">=</span><span class="n">dPX</span><span class="p">,</span> <span class="n">dPY</span> <span class="o">=</span><span class="n">dPY</span><span class="p">,</span> <span class="n">bckg_gap</span><span class="o">=</span><span class="n">bckg_gap</span><span class="p">,</span> <span class="n">monitor_name</span><span class="o">=</span><span class="n">monitor_name</span><span class="p">)</span>
</code></pre></div></div> <h3 id="detector-image">Detector image</h3> <p>Any detector image can be diagnosed with</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">refl</span><span class="p">.</span><span class="nf">show_detector_image</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xlim</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">450</span><span class="p">)</span>
</code></pre></div></div> <p><img src="/assets/img/SURF_XRR_det_rois.png" alt="Detector image with ROIs highlited"> On this image shadow from slits, detector gaps and ROIs can be clearly seen.</p> <h3 id="intensity-integration">Intensity integration</h3> <p>Let’s integrate the intensity in ROIs and plot it together:</p> <p><img src="/assets/img/SURF_raw_count_bckg.png" alt="Integrated intensity"></p> <h3 id="subtract-the-background">Subtract the background</h3> <p><img src="/assets/img/SURF_raw_count_bckg_sub.png" alt="Background-subtracted intensity"></p> <p>###</p> <p><img src="/assets/img/SURF_raw_count_bckg_sub.png" alt="Background-subtracted intensity"></p> </article> <h2>References</h2> <div class="publications"> </div> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2026 Egor A. Bersenev. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?c15de51d4bb57887caa2c21988d97279"></script> <script defer src="/assets/js/copy_code.js?c8a01c11a92744d44b093fc3bda915df" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-1DMC88ZQ0N"></script> <script defer src="/assets/js/google-analytics-setup.js"></script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>